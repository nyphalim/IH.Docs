---
title: CheckingPartnerProgram
description: Агент для запуска проверок закрепления рефералов и заказов в партнеских программах.
---

Класс \IH\CheckingPartnerProgram предназначен для запуска итераций проверок партнерских программ.


## Реализация
- Класс содержит набор статических методов.
- Точкой запуска является метод \IH\CheckingPartnerProgram::provider().
- Также реализован агент, который вызывает этот метод.

## Схема работы
- В момент вызова метода provider выбирается елемент инфоблока "Партнерские программы"
- При выборе используется фильтр:
  - Статус партнерки — Активна
  - Только сервисы с настроенными postback (Justclick, АвтоВебОфис, GetCourse, E-AutoPay) или партнерски в которых задано свойство PROPERTY_SERVICE_CPA
  - Дата последней проверки должна быть старше 60 дней
- После выборки в элемент партнерки сразу записывается дата текущей проверки
- Получаем объекты привязанные к партнерке (авторы и школы)
- Получаем трафик и клики по найденным объектам (за последние 30 дней)
- Получаем рефералов (за последние 30 дней)
- Получаем сделки (за последние 30 дней)
- Все полученные значения собираем в массив и вызываем метод addCheckingRecord(), который добавлет новую запись о проверке в таблицу \IH\CheckingPartnerProgramTable
  - Если трафик больше 100, кликов больше 10, рефералов 0 — устанавливаем флаг NEED_CHECK_REFS
  - Если трафик больше 300, рефералы > 0, а сделок нет — Устанавливаем флаг NEED_CHECK_DEALS
  - Если один из этих флагов равен true — устанавливаем флаг CHECKED = false — то есть нужна ручная проверка
  - Далее пробуем найти ближайшую предыдущую проверку этой партнерки (не старше 60 дней)
  - Если не нашли, то добавляем новую запись о проверке.
- Возвращаемся в метод provider() — в случае если пришел флаг CHECKED = false добавляем новую задачу менеджеру:
  - Если установлен флаг NEED_CHECK_REFS — Проверить закрепление рефералов
  - В противном случае — Проверить закрепление заказов
- Далее в этом же методе provider() устанавливается флаг "Проыверенная партнерка" в выбранный элемент — в случае если найдены оплаченные заказы за этот 30-дневный период. 
- После этого выполнение завершается.
- Агент вызывается каждые 300 секунд и итерация повторяется с новым элементом. Может быть пустая выборка, в этом случае итерация пропускается.
